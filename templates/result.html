{% extends "layout.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<div class="animate-entry">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
        <div style="max-width: 65%;">
            {% if is_multi %}
            <div style="margin-bottom: 0.5rem; font-size: 13px; color: var(--text-muted);">
                Resultado {{ current_page + 1 }} de {{ total_pages }} (Ordenado por Claridad)
            </div>
            {% endif %}
            <div style="display: flex; align-items: baseline; gap: 10px;">
                <h2 style="font-size: 24px; margin: 0; color: var(--header-text);">{{ data.ticker }}</h2>
                <h3 style="margin: 0; font-size: 16px; color: var(--text-muted); font-weight: 400;">{{ data.company_name
                    }}</h3>
            </div>
            <p style="color: var(--text-muted); font-size: 14px; margin-top: 4px; font-weight: 600;">
                Precio Actual: $<span id="currentPriceDisplay">{{ "%.2f"|format(data.current_price) }}</span>
                <span
                    style="font-weight: 400; margin-left: 10px; border-left: 1px solid var(--border-color); padding-left: 10px;">
                    An치lisis: {% if data.get('interval') == '1h' %}Por Hora (Corto Plazo){% else %}Diario (Est치ndar){%
                    endif %}
                </span>
                <span id="updateStatus"
                    style="font-weight: 400; font-size: 11px; margin-left:10px; color: #10b981; opacity: 0; transition: opacity 0.5s;">
                    Actualizado
                </span>
            </p>

            {% if data.company_summary %}
            <div
                style="margin-top: 1rem; font-size: 13px; color: var(--text-color); line-height: 1.5; max-height: 100px; overflow-y: auto; padding-right: 10px; opacity: 0.9; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                {{ data.company_summary }}
            </div>
            {% endif %}
        </div>

        <div style="display: flex; gap: 1rem;">
            {% if is_multi %}
            {% if current_page > 0 %}
            <a href="{{ url_for('multi_result', analysis_id=analysis_id, page=current_page-1) }}" class="btn"
                style="color: var(--text-color);">&larr; Anterior</a>
            {% endif %}

            {% if current_page < total_pages - 1 %} <a
                href="{{ url_for('multi_result', analysis_id=analysis_id, page=current_page+1) }}"
                class="btn btn-primary">Siguiente &rarr;</a>
                {% else %}
                <a href="/dashboard" class="btn btn-primary">Finalizar</a>
                {% endif %}
                {% else %}
                <a href="/dashboard" class="btn" style="color: var(--text-color);">Volver</a>
                {% endif %}
        </div>
    </div>



    <div class="glass-card prediction-summary">
        <h3 style="font-size: 16px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
            Consenso del Algoritmo</h3>
        {% set decision = data.summary.decision %}
        <div
            class="decision-huge {% if 'BUY' in decision or 'COMPRAR' in decision %}text-up{% elif 'SELL' in decision or 'VENDER' in decision %}text-down{% else %}text-neutral{% endif %}">
            {{ decision }}
        </div>
        <div
            style="display: flex; justify-content: center; gap: 2rem; margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <div style="text-align: center;">
                <span style="font-size: 1.5rem; font-weight: 600;" class="text-up">{{ data.summary.up_votes }}</span>
                <div style="font-size: 12px; color: var(--text-muted);">Alcista</div>
            </div>
            <div style="text-align: center;">
                <span style="font-size: 1.5rem; font-weight: 600;" class="text-down">{{ data.summary.down_votes
                    }}</span>
                <div style="font-size: 12px; color: var(--text-muted);">Bajista</div>
            </div>
            <div style="text-align: center;">
                <span style="font-size: 1.5rem; font-weight: 600;" class="text-neutral">{{ data.summary.neutral_votes
                    }}</span>
                <div style="font-size: 12px; color: var(--text-muted);">Neutral</div>
            </div>
        </div>
    </div>

    <h3 style="margin-bottom: 1rem; font-size: 18px;">Desglose del An치lisis</h3>
    <div class="results-grid">
        {% for item in data.results %}
        <div class="method-card" style="cursor: pointer;" onclick="openModal('{{ item.id }}')">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-color);">{{ item.method }}
                </h4>
                <span class="badge badge-{{ item.prediction }}">{{ item.prediction }}</span>
            </div>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 0.5rem; color: var(--header-text);">
                {{ item.value }}
            </div>
            <p style="margin: 0; font-size: 12px; color: var(--text-muted);">
                {{ item.desc }}
            </p>
            <div style="margin-top: 10px; font-size: 12px; color: #58a6ff; font-weight: 500;">
                Click para ver detalles &rarr;
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Main Price Chart -->
    <h3 style="margin-bottom: 1rem; margin-top: 2rem; font-size: 18px;">Gr치fico de Precios</h3>
    <div class="glass-card" style="margin-bottom: 2rem; padding: 1rem;">
        <div id="mainChart" style="width: 100%; height: 500px;"></div>
    </div>
</div>

<!-- Modal -->
<div id="analysisModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle"
            style="margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;"></h2>

        <div style="margin-bottom: 2rem;">
            <p id="modalExplanation" style="color: var(--text-color); margin-bottom: 1rem;"></p>
            <div style="background: rgba(110, 118, 129, 0.1); padding: 1rem; border-radius: 6px;">
                <h4 style="margin-top: 0; font-size: 14px; color: var(--text-muted); margin-bottom: 0.5rem;">Metodolog칤a
                </h4>
                <p id="modalMethodology"
                    style="margin: 0; font-size: 13px; color: var(--text-color); margin-bottom: 1rem;"></p>

                <h4 style="margin-top: 0; font-size: 14px; color: var(--text-muted); margin-bottom: 0.5rem;">Historia y
                    Origen</h4>
                <p id="modalHistory" style="margin: 0; font-size: 13px; color: var(--text-color); font-style: italic;">
                </p>
            </div>
        </div>

        <div style="height: 300px; width: 100%;">
            <canvas id="analysisChart"></canvas>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-primary" onclick="openPresentation()" style="width: 100%; max-width: 300px;">
                游꿉 Modo Clase: Ver Explicaci칩n Paso a Paso
            </button>
        </div>
    </div>
</div>

<!-- Presentation Modal (Full Screen) -->
<div id="presentationOverlay" class="modal-overlay" style="background: rgba(13, 17, 23, 0.98); z-index: 2000;">
    <div class="modal-content"
        style="max-width: 800px; width: 90%; height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative;">
        <span class="modal-close" onclick="closePresentation()"
            style="position: absolute; top: 20px; right: 20px; font-size: 2rem;">&times;</span>

        <div id="slideContainer"
            style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%;">
            <h2 id="slideTitle" style="font-size: 2.5rem; margin-bottom: 2rem; color: #58a6ff;"></h2>
            <div id="slideContent"
                style="font-size: 1.5rem; color: var(--text-color); line-height: 1.6; max-width: 80%;"></div>
        </div>

        <div
            style="margin-top: 2rem; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem;">
            <button class="btn" onclick="prevSlide()" id="btnPrevStart">&larr; Anterior</button>
            <span id="slideCounter" style="color: var(--text-muted);">1 / 10</span>
            <button class="btn btn-primary" onclick="nextSlide()" id="btnNextStart">Siguiente &rarr;</button>
        </div>
    </div>
</div>

<script>
    // Pass the full results object to JS
    const analysisData = {{ data.results | tojson }};
    const priceData = {{ data.price_data | tojson }};
    let currentChart = null;
    let currentSlides = [];
    let currentSlideIndex = 0;

    function openModal(id) {
        const item = analysisData.find(r => r.id === id);
        if (!item) return;

        // Store current item for presentation
        window.currentItem = item;

        document.getElementById('modalTitle').innerText = item.method;
        document.getElementById('modalExplanation').innerText = item.explanation;
        document.getElementById('modalMethodology').innerText = item.methodology;
        document.getElementById('modalHistory').innerText = item.history || 'Informaci칩n hist칩rica no disponible.';

        document.getElementById('analysisModal').style.display = 'flex';

        renderChart(item);
    }

    function openPresentation() {
        if (!window.currentItem || !window.currentItem.presentation) return;
        currentSlides = window.currentItem.presentation;
        currentSlideIndex = 0;
        showSlide(0);
        document.getElementById('presentationOverlay').style.display = 'flex';
        // Close underlying modal potentially? Or keep it open.
        // Let's keep it open behind.
    }

    function closePresentation() {
        document.getElementById('presentationOverlay').style.display = 'none';
    }

    function showSlide(index) {
        if (index < 0 || index >= currentSlides.length) return;
        currentSlideIndex = index;
        const slide = currentSlides[index];
        document.getElementById('slideTitle').innerHTML = slide.title;
        document.getElementById('slideContent').innerHTML = slide.content;
        document.getElementById('slideCounter').innerText = (index + 1) + " / " + currentSlides.length;

        // Update buttons
        document.getElementById('btnPrevStart').style.visibility = index === 0 ? 'hidden' : 'visible';
        document.getElementById('btnNextStart').innerText = index === currentSlides.length - 1 ? 'Finalizar' : 'Siguiente \u2192';
    }

    function nextSlide() {
        if (currentSlideIndex < currentSlides.length - 1) {
            showSlide(currentSlideIndex + 1);
        } else {
            closePresentation();
        }
    }

    function prevSlide() {
        if (currentSlideIndex > 0) {
            showSlide(currentSlideIndex - 1);
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function (event) {
        if (document.getElementById('presentationOverlay').style.display === 'flex') {
            if (event.key === 'ArrowRight') nextSlide();
            if (event.key === 'ArrowLeft') prevSlide();
            if (event.key === 'Escape') closePresentation();
        }
    });

    function closeModal() {
        document.getElementById('analysisModal').style.display = 'none';
        if (currentChart) {
            currentChart.destroy();
            currentChart = null;
        }
    }

    function renderChart(item) {
        const ctx = document.getElementById('analysisChart').getContext('2d');

        if (currentChart) {
            currentChart.destroy();
        }

        currentChart = new Chart(ctx, {
            type: item.chart_type || 'line',
            data: item.chart_data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#c9d1d9'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#30363d'
                        },
                        ticks: {
                            color: '#8b949e'
                        }
                    },
                    y: {
                        grid: {
                            color: '#30363d'
                        },
                        ticks: {
                            color: '#8b949e'
                        }
                    }
                }
            }
        });
    }

    // Render Main Chart
    if (priceData) {
        const trace1 = {
            x: priceData.dates,
            close: priceData.close,
            decreasing: { line: { color: '#ef4444' } },
            high: priceData.high,
            increasing: { line: { color: '#10b981' } },
            line: { color: 'rgba(31,119,180,1)' },
            low: priceData.low,
            open: priceData.open,
            type: 'candlestick',
            xaxis: 'x',
            yaxis: 'y',
            name: 'Price'
        };

        const layout = {
            title: 'Gr치fico de Precios (HLC)',
            dragmode: 'zoom',
            showlegend: false,
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            xaxis: {
                autorange: true,
                title: 'Fecha',
                gridcolor: '#30363d',
                tickfont: { color: '#8b949e' }
            },
            yaxis: {
                autorange: true,
                type: 'linear',
                gridcolor: '#30363d',
                tickfont: { color: '#8b949e' }
            },
            margin: {
                r: 10,
                t: 40,
                b: 40,
                l: 60
            },
            font: {
                family: 'Inter, sans-serif',
                color: '#c9d1d9'
            }
        };

        Plotly.newPlot('mainChart', [trace1], layout, { responsive: true });

        // Real-time polling
        const ticker = "{{ data.ticker }}";
        const interval = "{{ data.interval }}";

        setInterval(() => {
            fetch(`/result/${ticker}/json?timeframe=${interval}`)
                .then(response => response.json())
                .then(newData => {
                    if (newData.error) return;

                    // Update Price Display
                    const priceElement = document.getElementById('currentPriceDisplay');
                    if (priceElement) {
                        priceElement.innerText = newData.current_price.toFixed(2);

                        // Flash update effect
                        const status = document.getElementById('updateStatus');
                        if (status) {
                            status.style.opacity = '1';
                            setTimeout(() => { status.style.opacity = '0'; }, 2000);
                        }
                    }

                    // Update Chart
                    if (newData.price_data) {
                        const update = {
                            x: [newData.price_data.dates],
                            open: [newData.price_data.open],
                            high: [newData.price_data.high],
                            low: [newData.price_data.low],
                            close: [newData.price_data.close]
                        };

                        Plotly.update('mainChart', update);
                    }
                })
                .catch(err => console.error("Error polling data:", err));
        }, 30000); // 30 seconds
    }
</script>
{% endblock %}